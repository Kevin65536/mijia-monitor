# 项目设计总结

## 📋 项目概述

**项目名称**: 米家设备监控系统 (MiMonitor)  
**目标平台**: Windows 10/11  
**开发语言**: Python 3.9+  
**项目类型**: 桌面应用程序

## 🎯 核心设计目标

1. **易于使用** - 图形界面,一键启动,无需命令行操作
2. **方便打包** - 可打包为独立exe文件,用户无需安装Python
3. **稳定可靠** - 多线程架构,不阻塞UI,7x24小时稳定运行
4. **功能完整** - 监控、存储、报警、可视化一体化
5. **易于维护** - 模块化设计,代码清晰,便于扩展

## 🏗️ 技术架构

### 技术栈选择及理由

| 技术组件 | 选择 | 理由 |
|---------|------|------|
| **GUI框架** | PyQt6 | ✅ 原生Windows外观<br>✅ 跨平台支持<br>✅ 丰富的组件库<br>✅ 成熟稳定 |
| **数据库** | SQLite | ✅ 零配置,嵌入式<br>✅ 单文件存储<br>✅ 性能优秀<br>✅ Python内置支持 |
| **打包工具** | PyInstaller | ✅ 一键打包<br>✅ 单exe文件<br>✅ 自动处理依赖<br>✅ Windows兼容性好 |
| **配置管理** | YAML | ✅ 人类可读<br>✅ 层次化配置<br>✅ 注释支持 |
| **日志系统** | logging + colorlog | ✅ Python标准库<br>✅ 彩色输出<br>✅ 文件轮转 |

### 为什么不选择其他方案?

#### ❌ Electron + Web技术
- 打包体积大(100MB+)
- 内存占用高
- 启动速度慢
- 过度复杂

#### ❌ Tkinter
- 界面过时
- 组件功能有限
- 美观度不足

#### ❌ MySQL/PostgreSQL
- 需要额外安装数据库服务
- 配置复杂
- 对用户不友好
- SQLite足够满足需求

## 📊 系统架构

```
┌─────────────────────────────────────────────┐
│              用户界面层 (PyQt6)              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 主窗口   │  │ 设置对话框│  │ 系统托盘 │  │
│  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────┬───────────────────────────┘
                  │ 事件/信号
┌─────────────────▼───────────────────────────┐
│              业务逻辑层                      │
│  ┌──────────────────────────────────────┐  │
│  │      设备监控器 (DeviceMonitor)       │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │调度线程│  │工作线程│  │回调系统│ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│              数据访问层                      │
│  ┌──────────────────────────────────────┐  │
│  │    数据库管理器 (DatabaseManager)     │  │
│  │         SQLite Connection Pool        │  │
│  └──────────────────────────────────────┘  │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│              外部接口层                      │
│  ┌──────────────────────────────────────┐  │
│  │         米家API (mijiaAPI)            │  │
│  │         HTTP/HTTPS 通信               │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

## 🔄 数据流设计

### 监控数据流

```
米家云端
    ↓ (HTTP请求)
mijiaAPI.get_devices_prop()
    ↓
DeviceMonitor._monitor_device()
    ↓ (解析数据)
DatabaseManager.add_device_property()
    ↓ (存储)
SQLite database
    ↓ (查询)
MainWindow.refresh_device_list()
    ↓ (显示)
PyQt6 TableWidget
```

### 配置数据流

```
config.yaml
    ↓ (加载)
ConfigLoader.load()
    ↓ (解析)
Python Dict
    ↓ (使用)
各个模块
    ↓ (修改)
ConfigLoader.save()
    ↓ (保存)
config.yaml
```

## 🧵 线程模型

### 线程职责划分

1. **主线程 (Qt Event Loop)**
   - UI渲染和更新
   - 用户交互响应
   - 信号槽处理

2. **调度线程 (Scheduler)**
   - 任务分发
   - 监控间隔控制
   - 队列管理

3. **工作线程池 (Workers × 5)**
   - 设备状态采集
   - API请求执行
   - 数据存储操作

### 线程通信

- **主线程 → 监控线程**: 直接调用方法
- **监控线程 → 主线程**: PyQt6信号(Signal)
- **线程间同步**: threading.Lock

## 💾 数据库设计

### 表结构设计原则

1. **设备表** - 存储设备基本信息
   - 主键: did (设备ID)
   - 索引: name, model, online

2. **状态历史表** - 记录设备状态快照
   - 索引: (did, timestamp) - 优化时间范围查询

3. **属性历史表** - 记录具体属性值
   - 索引: (did, property_name, timestamp) - 支持按属性查询

4. **报警表** - 记录报警事件
   - 索引: (did, created_at) - 按时间查询

### 数据清理策略

- 默认保留30天数据
- 定期自动清理过期数据
- 支持手动备份

## 🔔 报警系统设计

### 规则引擎

```python
规则定义:
{
    "device_type": "sensor",     # 设备类型
    "property": "temperature",   # 监控属性
    "condition": ">",            # 条件运算符
    "threshold": 35,             # 阈值
    "enabled": true              # 是否启用
}

执行流程:
1. 获取设备最新属性值
2. 遍历所有启用的规则
3. 匹配设备类型
4. 检查条件是否满足
5. 触发报警回调
6. 发送系统通知
7. 记录到数据库
```

### 通知方式

- ✅ Windows系统托盘通知
- ✅ 数据库记录
- 🔜 邮件通知(未来)
- 🔜 微信通知(未来)

## 📦 打包发布方案

### PyInstaller配置

```python
# mi-monitor.spec
Analysis:
  - 指定入口文件: src/main.py
  - 包含配置文件: config/config.yaml
  - 隐藏导入: mijiaAPI, PyQt6等
  
EXE:
  - 单文件模式: onefile=True
  - 无控制台: console=False
  - 添加图标: icon='app.ico'
  - UPX压缩: upx=True
```

### 发布包结构

```
MiMonitor-v1.0.0-windows/
├── MiMonitor.exe         # 主程序
├── config/
│   └── config.yaml       # 配置文件模板
├── 启动监控.bat          # 快捷启动脚本
└── README.txt           # 简要说明
```

## 🎨 用户界面设计

### 主窗口布局

```
┌────────────────────────────────────────────┐
│  [刷新设备] [启动监控] [登录米家]   设备:10 │ ← 工具栏
├────────────────────────────────────────────┤
│ [设备列表] [报警记录] [统计信息]           │ ← 选项卡
│┌──────────────────────────────────────────┐│
││ 设备名称 │ 型号 │ 状态 │ 最后更新 │ 操作 ││
││─────────────────────────────────────────││
││ 客厅灯   │ xxx  │ 在线 │ 2分钟前  │[详情]││
││ 卧室传感器│ yyy  │ 离线 │ 10分钟前 │[详情]││
│└──────────────────────────────────────────┘│
│                                            │
└────────────────────────────────────────────┘
│ 就绪 | 监控中 | 设备: 10 在线: 8         │ ← 状态栏
└────────────────────────────────────────────┘
```

### 系统托盘

- 双击: 显示/隐藏主窗口
- 右键菜单:
  - 显示主窗口
  - 启动/停止监控
  - 退出程序

## 🔧 配置系统设计

### 配置文件层次

```yaml
app:              # 应用级配置
  name: ...
  version: ...
  
mijia:            # 米家API配置
  auth_file: ...
  timeout: ...
  
monitor:          # 监控配置
  default_interval: ...
  device_intervals:
    sensor: ...
    light: ...
  
database:         # 数据库配置
  path: ...
  retention_days: ...
  
logging:          # 日志配置
  level: ...
  file: ...
  
alerts:           # 报警配置
  enabled: ...
  rules: [...]
```

### 配置优先级

1. 用户配置文件 (`config/config.yaml`)
2. 默认配置 (代码内置)

## 📈 性能优化

### 数据库优化

- ✅ 使用索引加速查询
- ✅ 批量插入操作
- ✅ 连接池复用
- ✅ 定期VACUUM清理

### UI优化

- ✅ 虚拟列表(大量数据)
- ✅ 延迟加载
- ✅ 节流更新(1秒一次)
- ✅ 后台线程处理耗时操作

### 内存优化

- ✅ 限制历史数据缓存
- ✅ 定期清理过期数据
- ✅ 避免循环引用

## 🔐 安全考虑

### 认证信息保护

- 米家认证信息存储在本地文件
- 文件权限限制(仅当前用户可读)
- 不在日志中输出敏感信息

### 数据安全

- 本地SQLite数据库
- 支持定期备份
- 不上传用户数据

## 🚀 扩展性设计

### 插件化架构(未来)

```python
class MonitorPlugin:
    def on_device_update(self, data): pass
    def on_alert(self, alert): pass
    def get_config_schema(self): pass
```

### API接口(未来)

- REST API暴露监控数据
- WebSocket实时推送
- 第三方集成

## 📝 开发最佳实践

### 代码组织

- ✅ 单一职责原则
- ✅ 接口隔离
- ✅ 依赖注入
- ✅ 类型注解

### 错误处理

```python
try:
    # 操作
except SpecificException as e:
    logger.error(f"具体错误: {e}")
    # 友好提示用户
    # 继续运行或优雅退出
```

### 日志级别

- DEBUG: 详细调试信息
- INFO: 关键操作记录
- WARNING: 警告信息
- ERROR: 错误但可恢复
- CRITICAL: 致命错误

## 🎯 项目亮点

1. **开箱即用** - 打包为exe,双击即可运行
2. **用户友好** - 图形界面,简单直观
3. **稳定可靠** - 多线程架构,7x24运行
4. **功能完整** - 监控+存储+报警+可视化
5. **易于维护** - 模块化设计,代码清晰
6. **性能优秀** - SQLite+多线程,轻量高效
7. **完善文档** - README+开发文档+快速指南

## 📊 对比其他方案

| 特性 | 本项目 | Home Assistant | Node-RED | 自建Web服务 |
|------|--------|----------------|----------|-------------|
| 安装难度 | ⭐ 极简 | ⭐⭐⭐ 复杂 | ⭐⭐ 中等 | ⭐⭐⭐⭐ 困难 |
| 用户界面 | ⭐⭐⭐⭐ 原生 | ⭐⭐⭐ Web | ⭐⭐ Web | ⭐⭐⭐ Web |
| 资源占用 | ⭐⭐⭐⭐ 轻量 | ⭐⭐ 中等 | ⭐⭐⭐ 较轻 | ⭐⭐ 中等 |
| 功能丰富度 | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐⭐ 很全 | ⭐⭐⭐⭐ 全面 | ⭐⭐ 基础 |
| 定制化 | ⭐⭐⭐⭐ 高 | ⭐⭐⭐⭐ 高 | ⭐⭐⭐⭐⭐ 极高 | ⭐⭐⭐⭐⭐ 极高 |

## 🔮 未来规划

### v1.1 计划

- [ ] 图表可视化增强
- [ ] 数据导出功能
- [ ] 设备控制功能
- [ ] 更多报警渠道

### v1.2 计划

- [ ] 场景自动化
- [ ] 插件系统
- [ ] REST API
- [ ] 多语言支持

### v2.0 愿景

- [ ] 跨平台支持(macOS/Linux)
- [ ] 移动端应用
- [ ] 云端同步
- [ ] 智能分析

---

**设计理念**: 简单、高效、可靠、易用

**核心价值**: 为Windows用户提供最简单的米家设备监控解决方案
