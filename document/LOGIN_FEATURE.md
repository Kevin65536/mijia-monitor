# 登录功能更新说明

## 更新内容

本次更新对米家设备监控系统的登录功能进行了重大改进：

### 1. 智能登录按钮

- **未登录状态**：按钮显示"米家登录"
- **已登录状态**：按钮显示"退出登录"
- 按钮状态会根据当前登录状态自动更新

### 2. GUI二维码登录

不再使用命令行显示二维码，改为使用GUI弹窗：

- 点击"米家登录"按钮后，会弹出一个专门的登录对话框
- 对话框中会自动生成并显示二维码
- 使用米家APP扫描二维码即可完成登录
- 登录成功后自动刷新设备列表并启动监控

### 3. 退出登录功能

- 点击"退出登录"按钮
- 系统会提示确认是否退出
- 退出后会：
  - 停止所有设备监控
  - 删除本地认证文件
  - 将按钮状态更新为"米家登录"

## 技术实现

### 新增文件

- `src/ui/qr_login_dialog.py` - 二维码登录对话框组件

### 修改文件

- `src/ui/main_window.py` - 更新登录按钮逻辑和状态管理
- `src/ui/__init__.py` - 导出新的QRLoginDialog组件

### 主要功能模块

#### QRLoginDialog

二维码登录对话框，包含：
- `QRLoginWorker` - 后台工作线程，处理登录流程
- 二维码生成和显示
- 登录状态反馈
- 超时处理（60秒）

#### MainWindow 更新

- `update_login_button()` - 根据登录状态更新按钮文本
- `on_login_logout()` - 统一的登录/退出处理入口
- `login()` - 使用GUI二维码登录
- `logout()` - 退出登录并清理认证信息

## 使用方法

### 首次登录

1. 启动应用程序
2. 点击"米家登录"按钮
3. 在弹出的对话框中，使用米家APP扫描二维码
4. 等待登录成功提示
5. 系统自动刷新设备列表并启动监控

### 退出登录

1. 点击"退出登录"按钮
2. 在确认对话框中点击"Yes"
3. 系统停止监控并清除登录信息

### 重新登录

如果登录过期或需要切换账号：
1. 点击"退出登录"
2. 再次点击"米家登录"
3. 扫描新的二维码完成登录

## 注意事项

- 二维码有效期为60秒，超时需要重新生成
- 退出登录会停止所有设备监控
- 认证信息保存在 `config/mijia_auth.json`
- 登录成功后会自动启动设备监控（如果有设备）

## 依赖要求

- PySide6 >= 6.6.0
- Pillow >= 10.0.0
- qrcode（包含在mijiaAPI中）

## 开发者说明

### 线程安全

登录过程在独立的工作线程中执行，避免阻塞UI：
- 使用Qt信号槽机制进行线程间通信
- `qr_ready` - 二维码生成完成
- `login_success` - 登录成功
- `login_failed` - 登录失败

### 状态管理

登录状态通过 `monitor.api.available` 判断：
- `True` - 已登录且认证有效
- `False` - 未登录或认证已过期

### 扩展性

如需添加其他登录方式（如账号密码），可以：
1. 在 `QRLoginDialog` 中添加输入框
2. 扩展 `QRLoginWorker` 支持多种登录方式
3. 在 `login()` 方法中添加选择逻辑
